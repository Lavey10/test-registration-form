console.log('Is new user:', isNewUser);
console.log('User ID:', userId);
console.log('Full URL:', window.location.href);

        
class ProfileSetup {
constructor() {
this.skills = [];
@@ -956,3 +956,545 @@ <h4>Lead/Principal</h4>
{ name: 'Italian', category: 'Languages' },
{ name: 'Hindi', category: 'Languages' }
];
            }

            init() {
                this.setupEventListeners();
                this.loadUserData();
            }

            setupEventListeners() {
                // Experience level selection
                document.querySelectorAll('.experience-card').forEach(card => {
                    card.addEventListener('click', () => this.selectExperience(card));
                });

                // Skills input
                const skillInput = document.getElementById('skillInput');
                skillInput.addEventListener('input', (e) => this.handleSkillSearch(e));
                skillInput.addEventListener('keydown', (e) => this.handleSkillKeydown(e));
                skillInput.addEventListener('focus', () => {
                    if (skillInput.value.trim()) {
                        this.handleSkillSearch({ target: skillInput });
                    }
                });
                skillInput.addEventListener('blur', (e) => {
                    // Delay hiding to allow click on dropdown items
                    setTimeout(() => this.hideDropdown(), 200);
                });

                // Click outside to close dropdown
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.skills-container')) {
                        this.hideDropdown();
                    }
                });

                // File upload
                const fileUpload = document.getElementById('resumeUpload');
                const fileInput = document.getElementById('resumeFile');
                
                fileUpload.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                
                // Drag and drop
                fileUpload.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUpload.classList.add('dragover');
                });
                
                fileUpload.addEventListener('dragleave', () => {
                    fileUpload.classList.remove('dragover');
                });
                
                fileUpload.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileUpload.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.processFile(files[0]);
                    }
                });

                // Form submission
                document.getElementById('profileForm').addEventListener('submit', (e) => this.handleSubmit(e));
            }

            loadUserData() {
                if (!userId) {
                    this.showMessage('User ID not found. Please register again.', 'error');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                    return;
                }
                
                console.log('üë§ User ID:', userId);
                
                // ‚úÖ CHECK IF USER ALREADY HAS COMPLETED PROFILE
                this.checkExistingProfile(userId);
            }

            async checkExistingProfile(userId) {
                try {
                    console.log('üîç Checking if user profile already exists...');
                    
                    // Show loading state
                    document.getElementById('profileCheckLoading').style.display = 'block';
                    document.getElementById('profileFormContainer').style.display = 'none';
                    
                    const response = await fetch(`https://laveychaudhary.app.n8n.cloud/webhook/check-profile-status?user_id=${userId}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    console.log('üì° Profile check response:', response.status);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('üìã Profile status result:', result);
                        
                        // Hide loading state
                        document.getElementById('profileCheckLoading').style.display = 'none';
                        
                        // If user already has completed profile (checkmark = true)
                        if (result.profile_completed === true) {
                            document.getElementById('profileFormContainer').innerHTML = `
                                <div style="text-align: center; padding: 60px 20px;">
                                    <div style="font-size: 60px; margin-bottom: 20px;">üëã</div>
                                    <h2 style="color: #1f2937; margin-bottom: 16px; font-size: 28px;">Welcome back, ${result.user_name || 'User'}!</h2>
                                    <p style="color: #6b7280; margin-bottom: 30px; font-size: 16px;">You already have a completed profile. Taking you to your job dashboard...</p>
                                    <div style="background: #e0f2fe; border: 1px solid #0284c7; padding: 15px; border-radius: 8px; margin: 20px 0; color: #0369a1; font-size: 14px;">
                                        <strong>Auto-redirect:</strong> You'll be automatically taken to your dashboard in <span id="countdown">5</span> seconds.
                                    </div>
                                    <a href="https://lambent-pavlova-0444a6.netlify.app/dashboard.html?user_id=${userId}" 
                                       style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 32px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; text-decoration: none; display: inline-block; transition: transform 0.3s ease;">
                                        üéØ Go to Dashboard Now
                                    </a>
                                </div>
                            `;
                            
                            // Countdown and redirect
                            let countdown = 5;
                            const countdownElement = document.getElementById('countdown');
                            
                            const timer = setInterval(() => {
                                countdown--;
                                if (countdownElement) {
                                    countdownElement.textContent = countdown;
                                }
                                
                                if (countdown <= 0) {
                                    clearInterval(timer);
                                    window.location.href = `https://lambent-pavlova-0444a6.netlify.app/dashboard.html?user_id=${userId}`;
                                }
                            }, 1000);
                            
                            return;
                        } else {
                            // Profile not completed - show form
                            console.log('üë§ Profile incomplete or new user - showing profile setup form');
                            this.showMessage('Please complete your profile to start receiving job matches.', 'info');
                            document.getElementById('profileFormContainer').style.display = 'block';
                            document.getElementById('profileForm').dataset.userId = userId;
                        }
                    } else {
                        // If check fails, assume new user and continue
                        console.log('‚ö†Ô∏è Profile check failed, treating as new user');
                        document.getElementById('profileCheckLoading').style.display = 'none';
                        document.getElementById('profileFormContainer').style.display = 'block';
                        document.getElementById('profileForm').dataset.userId = userId;
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error checking user profile status:', error);
                    // Continue with form setup as fallback
                    document.getElementById('profileCheckLoading').style.display = 'none';
                    document.getElementById('profileFormContainer').style.display = 'block';
                    this.showMessage('Unable to verify profile status. Please continue with setup.', 'info');
                    document.getElementById('profileForm').dataset.userId = userId;
                }
            }

            selectExperience(selectedCard) {
                // Remove selection from all cards
                document.querySelectorAll('.experience-card').forEach(card => {
                    card.classList.remove('selected');
                });

                // Add selection to clicked card
                selectedCard.classList.add('selected');
                document.getElementById('experienceLevel').value = selectedCard.dataset.experience;
            }

            handleSkillSearch(event) {
                const query = event.target.value.toLowerCase().trim();
                
                if (query.length === 0) {
                    this.hideDropdown();
                    return;
                }
                
                // Filter skills based on search query
                this.filteredSkills = this.skillsDatabase.filter(skill => 
                    skill.name.toLowerCase().includes(query) && 
                    !this.skills.includes(skill.name)
                ).slice(0, 8); // Show max 8 results
                
                this.renderDropdown();
                this.selectedDropdownIndex = -1;
            }

            handleSkillKeydown(event) {
                const dropdown = document.getElementById('skillsDropdown');
                
                if (!dropdown.classList.contains('show') || this.filteredSkills.length === 0) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        const skillName = event.target.value.trim();
                        if (skillName) {
                            this.addSkill(skillName);
                            event.target.value = '';
                            this.hideDropdown();
                        }
                    }
                    return;
                }
                
                switch (event.key) {
                    case 'ArrowDown':
                        event.preventDefault();
                        this.selectedDropdownIndex = Math.min(
                            this.selectedDropdownIndex + 1, 
                            this.filteredSkills.length - 1
                        );
                        this.updateDropdownHighlight();
                        break;
                        
                    case 'ArrowUp':
                        event.preventDefault();
                        this.selectedDropdownIndex = Math.max(this.selectedDropdownIndex - 1, -1);
                        this.updateDropdownHighlight();
                        break;
                        
                    case 'Enter':
                        event.preventDefault();
                        if (this.selectedDropdownIndex >= 0 && this.selectedDropdownIndex < this.filteredSkills.length) {
                            this.addSkill(this.filteredSkills[this.selectedDropdownIndex].name);
                        } else {
                            // Add custom skill if no dropdown selection
                            const skillName = event.target.value.trim();
                            if (skillName) {
                                this.addSkill(skillName);
                            }
                        }
                        event.target.value = '';
                        this.hideDropdown();
                        break;
                        
                    case 'Escape':
                        this.hideDropdown();
                        event.target.blur();
                        break;
                }
            }

            renderDropdown() {
                const dropdown = document.getElementById('skillsDropdown');
                
                if (this.filteredSkills.length === 0) {
                    dropdown.innerHTML = '<div class="dropdown-item" style="color: #9ca3af; cursor: default;">No matching skills found</div>';
                } else {
                    dropdown.innerHTML = this.filteredSkills.map((skill, index) => `
                        <div class="dropdown-item" data-skill="${skill.name}" data-index="${index}">
                            <span>${skill.name}</span>
                            <span class="skill-category-tag">${skill.category}</span>
                        </div>
                    `).join('');
                    
                    // Add click handlers to dropdown items
                    dropdown.querySelectorAll('.dropdown-item[data-skill]').forEach(item => {
                        item.addEventListener('mousedown', (e) => {
                            e.preventDefault(); // Prevent blur event
                        });
                        
                        item.addEventListener('click', () => {
                            this.addSkill(item.dataset.skill);
                            document.getElementById('skillInput').value = '';
                            this.hideDropdown();
                            document.getElementById('skillInput').focus();
                        });
                        
                        item.addEventListener('mouseenter', () => {
                            this.selectedDropdownIndex = parseInt(item.dataset.index);
                            this.updateDropdownHighlight();
                        });
                    });
                }
                
                this.showDropdown();
            }

            updateDropdownHighlight() {
                const items = document.querySelectorAll('#skillsDropdown .dropdown-item[data-skill]');
                items.forEach((item, index) => {
                    item.classList.toggle('highlighted', index === this.selectedDropdownIndex);
                });
            }

            showDropdown() {
                const dropdown = document.getElementById('skillsDropdown');
                dropdown.classList.add('show');
            }

            hideDropdown() {
                const dropdown = document.getElementById('skillsDropdown');
                dropdown.classList.remove('show');
                this.selectedDropdownIndex = -1;
            }

            addSkill(skillName) {
                if (!skillName || skillName.length < 2) {
                    return;
                }

                // Check if skill already exists (case insensitive)
                if (this.skills.some(skill => skill.toLowerCase() === skillName.toLowerCase())) {
                    this.showMessage('Skill already added', 'info');
                    return;
                }

                // Add skill to array
                this.skills.push(skillName);
                
                // Create skill tag element
                const skillTag = document.createElement('div');
                skillTag.className = 'skill-tag';
                skillTag.innerHTML = `
                    <span>${skillName}</span>
                    <button type="button" class="remove-skill" data-skill="${skillName}">√ó</button>
                `;

                // Add remove functionality
                skillTag.querySelector('.remove-skill').addEventListener('click', () => {
                    this.removeSkill(skillName);
                    skillTag.remove();
                });

                // Add to skills container
                document.getElementById('skillsTags').appendChild(skillTag);
                
                // Hide placeholder if skills exist
                const placeholder = document.getElementById('skillsPlaceholder');
                if (this.skills.length > 0) {
                    placeholder.classList.add('hidden');
                }
                
                // Update hidden input
                document.getElementById('skills').value = JSON.stringify(this.skills);
                
                console.log('‚úÖ Skill added:', skillName);
            }

            removeSkill(skillName) {
                this.skills = this.skills.filter(skill => skill !== skillName);
                
                // Show placeholder if no skills left
                const placeholder = document.getElementById('skillsPlaceholder');
                if (this.skills.length === 0) {
                    placeholder.classList.remove('hidden');
                }
                
                document.getElementById('skills').value = JSON.stringify(this.skills);
                console.log('‚ùå Skill removed:', skillName);
            }

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    this.processFile(file);
                }
            }

            processFile(file) {
                // Validate file type
                const allowedTypes = ['application/pdf', 'application/msword', 
                                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
                if (!allowedTypes.includes(file.type)) {
                    this.showMessage('Please upload a PDF, DOC, or DOCX file', 'error');
                    return;
                }

                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    this.showMessage('File size must be less than 5MB', 'error');
                    return;
                }

                this.uploadedFile = file;
                this.displayUploadedFile(file);
            }

            displayUploadedFile(file) {
                const fileInfo = document.getElementById('uploadedFileInfo');
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                
                fileInfo.innerHTML = `
                    <div class="uploaded-file">
                        <div class="file-icon">üìÑ</div>
                        <div class="file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${fileSize} MB</div>
                        </div>
                        <button type="button" onclick="this.parentElement.remove(); document.getElementById('resumeFile').value = ''; profileSetup.uploadedFile = null;" 
                                style="background: none; border: none; color: #ef4444; font-size: 18px; cursor: pointer;">√ó</button>
                    </div>
                `;
            }

            validateForm() {
                const requiredFields = [
                    { id: 'professionalTitle', message: 'Professional title is required' },
                    { id: 'location', message: 'Location is required' },
                    { id: 'experienceLevel', message: 'Please select your experience level' },
                    { id: 'yearsExperience', message: 'Years of experience is required' },
                    { id: 'salaryMin', message: 'Minimum salary is required' },
                    { id: 'salaryMax', message: 'Maximum salary is required' },
                    { id: 'currency', message: 'Currency is required' }
                ];

                for (const field of requiredFields) {
                    const element = document.getElementById(field.id);
                    if (!element.value.trim()) {
                        this.showMessage(field.message, 'error');
                        element.focus();
                        return false;
                    }
                }

                if (this.skills.length < 3) {
                    this.showMessage('Please add at least 3 skills', 'error');
                    document.getElementById('skillInput').focus();
                    return false;
                }

                const minSalary = parseInt(document.getElementById('salaryMin').value);
                const maxSalary = parseInt(document.getElementById('salaryMax').value);
                
                if (maxSalary <= minSalary) {
                    this.showMessage('Maximum salary must be greater than minimum salary', 'error');
                    document.getElementById('salaryMax').focus();
                    return false;
                }

                return true;
            }

            async handleSubmit(event) {
                event.preventDefault();
                
                if (!this.validateForm()) {
                    return;
                }

                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span style="display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s linear infinite; margin-right: 8px;"></span>Completing Profile...';

                try {
                    // Create FormData for file upload support
                    const formData = new FormData();
                    
                    // Add all form fields
                    formData.append('user_id', document.getElementById('profileForm').dataset.userId);
                    formData.append('professionalTitle', document.getElementById('professionalTitle').value.trim());
                    formData.append('location', document.getElementById('location').value.trim());
                    formData.append('experienceLevel', document.getElementById('experienceLevel').value);
                    formData.append('yearsExperience', document.getElementById('yearsExperience').value);
                    formData.append('salaryMin', document.getElementById('salaryMin').value);
                    formData.append('salaryMax', document.getElementById('salaryMax').value);
                    formData.append('currency', document.getElementById('currency').value);
                    
                    // Add skills as JSON string
                    formData.append('skills', JSON.stringify(this.skills));
                    
                    // Add metadata
                    formData.append('timestamp', new Date().toISOString());
                    formData.append('profileComplete', 'true');
                    
                    // Add resume file if uploaded
                    if (this.uploadedFile) {
                        formData.append('resumeFile', this.uploadedFile);
                        formData.append('hasResume', 'true');
                        formData.append('resumeFileName', this.uploadedFile.name);
                        console.log('‚úÖ Resume file added to FormData');
                    } else {
                        formData.append('hasResume', 'false');
                        console.log('‚ùå No resume file to upload');
                    }

                    console.log('üì§ Submitting profile data with FormData');

                    const response = await fetch('https://laveychaudhary.app.n8n.cloud/webhook/profile-setup', {
                        method: 'POST',
                        body: formData 
                    });

                    console.log('üì° Response status:', response.status);

                    if (response.ok) {
                        const result = await response.json();
                        console.log('‚úÖ Profile setup successful:', result);
                        
                        // ‚úÖ PHASE 2: STORE NEW USER FLAG IN SESSION STORAGE
                        if (isNewUser) {
                            console.log('üîÑ Storing new user completion flag for dashboard');
                            sessionStorage.setItem('justCompletedProfile', 'true');
                            sessionStorage.setItem('completionUserId', result.user_id || userId);
                        }
                        
                        this.showMessage('üéâ Profile completed successfully! Redirecting to your dashboard...', 'success');
                        
                        setTimeout(() => {
                            window.location.href = result.redirect_url || `https://lambent-pavlova-0444a6.netlify.app/dashboard.html?user_id=${document.getElementById('profileForm').dataset.userId}`;
                        }, 2000);
                        
                    } else {
                        const errorText = await response.text();
                        console.error('‚ùå Server response:', errorText);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                } catch (error) {
                    console.error('‚ùå Profile setup failed:', error);
                    this.showMessage('Failed to complete profile. Please try again.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Complete Profile Setup';
                }
            }

            showMessage(text, type) {
                const messageDiv = document.getElementById('message');
                messageDiv.textContent = text;
                messageDiv.className = `message ${type}`;
                messageDiv.style.display = 'block';
                
                // Auto hide after 5 seconds for non-error messages
                if (type !== 'error') {
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 5000);
                }
                
                console.log(`üí¨ ${type.toUpperCase()}: ${text}`);
            }
        }

        // Initialize when page loads
        const profileSetup = new ProfileSetup();
    </script>
</body>
</html>
